DROP TABLE IF EXISTS Polls;
DROP TABLE IF EXISTS Options;
DROP TABLE IF EXISTS Votes;

CREATE TABLE Polls (
  PollID     serial,
  Question   varchar(255),
  Username   char(16),
  Time       timestamp,
  LastUpdate timestamp,
  Message    char(16),
  Channel    char(16));

CREATE TABLE Options (
  OptionID  serial,
  PollID    int,
  Original  bool,
  Username  char(16),
  Emoji     char(8),
  Option    varchar(255));

CREATE TABLE Votes (
  Username  char(16),
  OptionID  int);

DROP VIEW IF EXISTS MaxVotes;
DROP VIEW IF EXISTS OptionVotes;

CREATE OR REPLACE VIEW OptionVotes AS (
  SELECT
    MAX(O.PollID) AS PollID,
    MAX(O.Option) AS Option,
    COUNT(V.Username) AS VoteCount
  FROM Options AS O
  LEFT OUTER JOIN Votes AS V
  ON O.OptionID=V.OptionID
  GROUP BY O.OptionID);

CREATE OR REPLACE VIEW MaxVotes AS (
  SELECT
    PollID,
    MAX(VoteCount) AS VoteCount
  FROM OptionVotes GROUP BY PollID);

SELECT MAX(P.Question), MAX(O.Option)
FROM (
  SELECT
    Question,
    PollID
  FROM Polls
  ORDER BY PollID DESC
  OFFSET 0
  LIMIT 10
) AS P
INNER JOIN OptionVotes AS O ON P.PollID=O.PollID
INNER JOIN MaxVotes AS MV ON MV.PollID=P.PollID AND O.VoteCount=MV.VoteCount;